---
description: "Obsidian æ’ä»¶å¼€å‘æ£€æŸ¥æ¸…å•"
scopes: [chat, edit]
tags: [obsidian, plugin, security, dom]
priority: 100
globs: ["**/*.ts", "**/*.js"]
alwaysApply: false
---

# Obsidian æ’ä»¶å¼€å‘æ£€æŸ¥æ¸…å•

> **é‡è¦æ€§**: â­â­â­â­ é«˜ä¼˜å…ˆçº§  
> **åŠ è½½æ–¹å¼**: Auto-Attachï¼ˆç¼–è¾‘ TS/JS æ–‡ä»¶æ—¶è‡ªåŠ¨åŠ è½½ï¼‰  
> **ç”¨é€”**: Obsidian æ’ä»¶ç‰¹å®šçš„å¼€å‘çº¦æŸå’Œæœ€ä½³å®è·µ  

---

## ğŸ”’ å®‰å…¨æ€§è§„åˆ™ï¼ˆç»å¯¹ç¦æ­¢ï¼‰

### 1. æ°¸ä¸ä½¿ç”¨ä¸å®‰å…¨çš„ DOM æ“ä½œ âš ï¸

```typescript
// âŒ ç»å¯¹ç¦æ­¢
element.innerHTML = userContent;
element.outerHTML = '<div>...</div>';
container.insertAdjacentHTML('beforeend', htmlString);

// âœ… æ­£ç¡®åšæ³•
const div = this.containerEl.createDiv({ cls: 'my-class' });
div.appendText(userContent);
div.createEl('span', { text: 'Safe text' });
```

**åŸå› **ï¼š
- `innerHTML` å¯èƒ½å¯¼è‡´ XSS æ”»å‡»
- ç”¨æˆ·è¾“å…¥æœªç»æ¸…ç†ç›´æ¥æ¸²æŸ“æ˜¯ä¸¥é‡å®‰å…¨æ¼æ´
- Obsidian æä¾›äº†å®‰å…¨çš„ DOM API

### 2. å¿…é¡»æ¸…ç†ç”¨æˆ·è¾“å…¥ âš ï¸

```typescript
// âŒ å±é™©
const userInput = this.inputEl.value;
container.innerHTML = userInput; // XSS é£é™©

// âœ… æ­£ç¡®
const userInput = this.inputEl.value;
container.empty();
container.appendText(userInput); // è‡ªåŠ¨è½¬ä¹‰

// âœ… æˆ–ä½¿ç”¨ Obsidian çš„æ¸²æŸ“å™¨
MarkdownRenderer.render(
    this.app,
    userInput,
    container,
    '',
    this
);
```

---

## ğŸ¨ DOM æ“ä½œæœ€ä½³å®è·µ

### ä½¿ç”¨ Obsidian æä¾›çš„è¾…åŠ©å‡½æ•°

```typescript
// âœ… åˆ›å»ºå…ƒç´ 
const container = this.containerEl.createDiv({ cls: 'chat-container' });
const header = container.createEl('h2', { text: 'AI Chat' });
const button = container.createEl('button', {
    text: 'Send',
    cls: 'chat-send-btn'
});

// âœ… æ·»åŠ æ–‡æœ¬
container.appendText('Plain text content');

// âœ… è®¾ç½®å±æ€§
button.setAttribute('disabled', 'true');
button.addEventListener('click', () => { ... });

// âœ… æ¸…ç©ºå®¹å™¨
container.empty();

// âœ… ç§»é™¤å…ƒç´ 
element.remove();
```

### å¸¸ç”¨ DOM API å‚è€ƒ

| æ–¹æ³• | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| `createDiv(attrs)` | åˆ›å»º div å…ƒç´  | `container.createDiv({ cls: 'my-class' })` |
| `createEl(tag, attrs)` | åˆ›å»ºæŒ‡å®šå…ƒç´  | `container.createEl('span', { text: 'Hi' })` |
| `appendText(text)` | æ·»åŠ æ–‡æœ¬ï¼ˆè‡ªåŠ¨è½¬ä¹‰ï¼‰ | `el.appendText(userInput)` |
| `empty()` | æ¸…ç©ºæ‰€æœ‰å­å…ƒç´  | `container.empty()` |
| `remove()` | ç§»é™¤å…ƒç´  | `element.remove()` |
| `addClass(cls)` | æ·»åŠ  CSS ç±» | `el.addClass('active')` |
| `removeClass(cls)` | ç§»é™¤ CSS ç±» | `el.removeClass('active')` |
| `toggleClass(cls)` | åˆ‡æ¢ CSS ç±» | `el.toggleClass('hidden')` |

---

## âš™ï¸ æ’ä»¶ç”Ÿå‘½å‘¨æœŸ

### æ ‡å‡†ç»“æ„

```typescript
import { Plugin, PluginSettingTab, Setting } from 'obsidian';

export default class MyPlugin extends Plugin {
    settings: MyPluginSettings;
    
    async onload() {
        console.log('Loading plugin...');
        
        // 1. åŠ è½½è®¾ç½®
        await this.loadSettings();
        
        // 2. æ³¨å†Œè§†å›¾
        this.registerView(
            VIEW_TYPE,
            (leaf) => new MyView(leaf, this)
        );
        
        // 3. æ³¨å†Œå‘½ä»¤
        this.addCommand({
            id: 'my-command',
            name: 'My Command',
            callback: () => { ... }
        });
        
        // 4. æ³¨å†Œäº‹ä»¶
        this.registerEvent(
            this.app.workspace.on('active-leaf-change', () => { ... })
        );
        
        // 5. æ³¨å†Œ DOM äº‹ä»¶
        this.registerDomEvent(document, 'click', (evt) => { ... });
        
        // 6. æ³¨å†Œè®¾ç½®é¢æ¿
        this.addSettingTab(new MySettingTab(this.app, this));
    }
    
    onunload() {
        console.log('Unloading plugin...');
        // æ¸…ç†èµ„æºï¼ˆObsidian ä¼šè‡ªåŠ¨æ¸…ç†æ³¨å†Œçš„äº‹ä»¶ï¼‰
    }
    
    async loadSettings() {
        this.settings = Object.assign(
            {},
            DEFAULT_SETTINGS,
            await this.loadData()
        );
    }
    
    async saveSettings() {
        await this.saveData(this.settings);
    }
}
```

---

## ğŸ¯ è§†å›¾ï¼ˆViewï¼‰å¼€å‘

### æ ‡å‡†è§†å›¾ç»“æ„

```typescript
import { ItemView, WorkspaceLeaf } from 'obsidian';

export const VIEW_TYPE = 'my-view';

export class MyView extends ItemView {
    constructor(leaf: WorkspaceLeaf) {
        super(leaf);
    }
    
    getViewType() {
        return VIEW_TYPE;
    }
    
    getDisplayText() {
        return 'My View';
    }
    
    getIcon() {
        return 'dice'; // Obsidian å†…ç½®å›¾æ ‡
    }
    
    async onOpen() {
        // åˆå§‹åŒ– UI
        const container = this.containerEl.children[1];
        container.empty();
        container.addClass('my-view-container');
        
        // æ„å»º UI
        const header = container.createEl('h2', { text: 'My View' });
        // ...
    }
    
    async onClose() {
        // æ¸…ç†èµ„æº
    }
}
```

### æ¿€æ´»è§†å›¾

```typescript
// åœ¨æ’ä»¶çš„ onload() ä¸­
this.addCommand({
    id: 'open-my-view',
    name: 'Open My View',
    callback: async () => {
        const { workspace } = this.app;
        
        // æ£€æŸ¥è§†å›¾æ˜¯å¦å·²å­˜åœ¨
        let leaf = workspace.getLeavesOfType(VIEW_TYPE)[0];
        
        if (!leaf) {
            // åˆ›å»ºæ–°è§†å›¾
            const leaf = workspace.getRightLeaf(false);
            await leaf.setViewState({
                type: VIEW_TYPE,
                active: true
            });
        }
        
        // æ¿€æ´»è§†å›¾
        workspace.revealLeaf(leaf);
    }
});
```

---

## âš™ï¸ è®¾ç½®ï¼ˆSettingsï¼‰å¼€å‘

### å®šä¹‰è®¾ç½®æ¥å£

```typescript
interface MyPluginSettings {
    apiKey: string;
    model: string;
    temperature: number;
    enabled: boolean;
}

const DEFAULT_SETTINGS: MyPluginSettings = {
    apiKey: '',
    model: 'gpt-4',
    temperature: 0.7,
    enabled: true
};
```

### è®¾ç½®é¢æ¿

```typescript
import { App, PluginSettingTab, Setting } from 'obsidian';

export class MySettingTab extends PluginSettingTab {
    plugin: MyPlugin;
    
    constructor(app: App, plugin: MyPlugin) {
        super(app, plugin);
        this.plugin = plugin;
    }
    
    display(): void {
        const { containerEl } = this;
        containerEl.empty();
        
        containerEl.createEl('h2', { text: 'My Plugin Settings' });
        
        // æ–‡æœ¬è¾“å…¥
        new Setting(containerEl)
            .setName('API Key')
            .setDesc('Your API key')
            .addText(text => text
                .setPlaceholder('Enter API key')
                .setValue(this.plugin.settings.apiKey)
                .onChange(async (value) => {
                    this.plugin.settings.apiKey = value;
                    await this.plugin.saveSettings();
                }));
        
        // ä¸‹æ‹‰é€‰æ‹©
        new Setting(containerEl)
            .setName('Model')
            .setDesc('Choose AI model')
            .addDropdown(dropdown => dropdown
                .addOption('gpt-4', 'GPT-4')
                .addOption('gpt-3.5-turbo', 'GPT-3.5 Turbo')
                .setValue(this.plugin.settings.model)
                .onChange(async (value) => {
                    this.plugin.settings.model = value;
                    await this.plugin.saveSettings();
                }));
        
        // æ»‘å—
        new Setting(containerEl)
            .setName('Temperature')
            .setDesc('Creativity level')
            .addSlider(slider => slider
                .setLimits(0, 1, 0.1)
                .setValue(this.plugin.settings.temperature)
                .setDynamicTooltip()
                .onChange(async (value) => {
                    this.plugin.settings.temperature = value;
                    await this.plugin.saveSettings();
                }));
        
        // å¼€å…³
        new Setting(containerEl)
            .setName('Enable feature')
            .setDesc('Turn on/off')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.enabled)
                .onChange(async (value) => {
                    this.plugin.settings.enabled = value;
                    await this.plugin.saveSettings();
                }));
    }
}
```

---

## ğŸ¹ å¿«æ·é”®ï¼ˆHotkeysï¼‰

### âŒ ä¸è¦è®¾ç½®é»˜è®¤å¿«æ·é”®

```typescript
// âŒ é”™è¯¯ï¼šè®¾ç½®é»˜è®¤å¿«æ·é”®
this.addCommand({
    id: 'my-command',
    name: 'My Command',
    hotkeys: [{ modifiers: ['Ctrl'], key: 'K' }], // å¯èƒ½å†²çª
    callback: () => { ... }
});

// âœ… æ­£ç¡®ï¼šä¸è®¾ç½®é»˜è®¤å¿«æ·é”®
this.addCommand({
    id: 'my-command',
    name: 'My Command',
    // ä¸è®¾ç½® hotkeysï¼Œè®©ç”¨æˆ·è‡ªå·±é…ç½®
    callback: () => { ... }
});
```

**åŸå› **ï¼š
- é¿å…ä¸ç”¨æˆ·ç°æœ‰å¿«æ·é”®å†²çª
- è®©ç”¨æˆ·é€šè¿‡ Obsidian è®¾ç½®è‡ªå·±é…ç½®
- åœ¨ README ä¸­å»ºè®®æ¨èå¿«æ·é”®

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. æœ€å°åŒ–æ§åˆ¶å°æ—¥å¿—

```typescript
// âŒ ç”Ÿäº§ç¯å¢ƒæœ‰å¤§é‡æ—¥å¿—
console.log('Debug info...');
console.log('User input:', userInput);

// âœ… ä½¿ç”¨æ¡ä»¶æ—¥å¿—
const DEBUG = false; // æˆ–ä»è®¾ç½®ä¸­è¯»å–

if (DEBUG) {
    console.log('Debug info...');
}

// âœ… æˆ–ä½¿ç”¨å¼€å‘ç¯å¢ƒæ ‡å¿—
if (process.env.NODE_ENV === 'development') {
    console.log('Debug info...');
}
```

### 2. å¼‚æ­¥æ“ä½œ

```typescript
// âœ… ä½¿ç”¨ async/await
async loadData() {
    try {
        const data = await this.loadData();
        this.processData(data);
    } catch (error) {
        console.error('Failed to load data:', error);
        new Notice('Failed to load data');
    }
}

// âœ… é¿å…é˜»å¡ä¸»çº¿ç¨‹
async heavyComputation() {
    // åˆ†æ‰¹å¤„ç†
    for (let i = 0; i < items.length; i += 100) {
        const batch = items.slice(i, i + 100);
        await this.processBatch(batch);
        
        // ç»™ä¸»çº¿ç¨‹å–˜æ¯æ—¶é—´
        await new Promise(resolve => setTimeout(resolve, 0));
    }
}
```

### 3. äº‹ä»¶æ¸…ç†

```typescript
// âœ… ä½¿ç”¨ registerEvent è‡ªåŠ¨æ¸…ç†
this.registerEvent(
    this.app.workspace.on('active-leaf-change', () => { ... })
);

// âœ… ä½¿ç”¨ registerDomEvent è‡ªåŠ¨æ¸…ç†
this.registerDomEvent(document, 'click', (evt) => { ... });

// âŒ æ‰‹åŠ¨æ·»åŠ çš„äº‹ä»¶éœ€è¦æ‰‹åŠ¨æ¸…ç†
document.addEventListener('click', handler);
// éœ€è¦åœ¨ onunload() ä¸­ï¼š
document.removeEventListener('click', handler);
```

---

## ğŸ”§ é”™è¯¯å¤„ç†

### æ ‡å‡†é”™è¯¯å¤„ç†æ¨¡å¼

```typescript
import { Notice } from 'obsidian';

// âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
async myFunction() {
    try {
        const result = await someAsyncOperation();
        return result;
    } catch (error) {
        // 1. è®°å½•è¯¦ç»†é”™è¯¯
        console.error('MyFunction failed:', error);
        
        // 2. å‘ç”¨æˆ·æ˜¾ç¤ºå‹å¥½æ¶ˆæ¯
        new Notice('Operation failed. Please try again.');
        
        // 3. å¤„ç†ç‰¹å®šé”™è¯¯
        if (error.message.includes('network')) {
            new Notice('Network error. Check your connection.');
        }
        
        // 4. é‡æ–°æŠ›å‡ºæˆ–è¿”å›é»˜è®¤å€¼
        throw error; // æˆ– return null;
    }
}
```

---

## ğŸ“‹ å¼€å‘æ£€æŸ¥æ¸…å•

### ä»£ç æäº¤å‰æ£€æŸ¥

- [ ] **å®‰å…¨æ€§**
  - [ ] æœªä½¿ç”¨ `innerHTML` / `outerHTML`
  - [ ] æ‰€æœ‰ç”¨æˆ·è¾“å…¥å·²æ¸…ç†
  - [ ] ä½¿ç”¨ Obsidian DOM API

- [ ] **æ€§èƒ½**
  - [ ] ç§»é™¤æˆ–æ¡ä»¶åŒ–æ‰€æœ‰ `console.log`
  - [ ] å¼‚æ­¥æ“ä½œä¸é˜»å¡ä¸»çº¿ç¨‹
  - [ ] äº‹ä»¶ç›‘å¬å·²æ­£ç¡®æ³¨å†Œ

- [ ] **é”™è¯¯å¤„ç†**
  - [ ] æ‰€æœ‰ async æ“ä½œæœ‰ try/catch
  - [ ] é”™è¯¯æœ‰å‹å¥½çš„ç”¨æˆ·æç¤º
  - [ ] é”™è¯¯æœ‰è¯¦ç»†çš„æ—¥å¿—

- [ ] **ç”¨æˆ·ä½“éªŒ**
  - [ ] æœªè®¾ç½®é»˜è®¤å¿«æ·é”®
  - [ ] è®¾ç½®é¢æ¿æ¸…æ™°æ˜“ç”¨
  - [ ] Notice æ¶ˆæ¯ç®€æ´æ˜äº†

- [ ] **ä»£ç è´¨é‡**
  - [ ] æ—  TypeScript é”™è¯¯
  - [ ] éµå¾ªé¡¹ç›®ä»£ç é£æ ¼
  - [ ] æ³¨é‡Šæ¸…æ™°å®Œæ•´

---

## ğŸ”— ç›¸å…³èµ„æº

- **Obsidian API**: https://docs.obsidian.md/
- **æ’ä»¶å¼€å‘æŒ‡å—**: https://marcus.se.net/obsidian-plugin-docs/
- **ç¤ºä¾‹æ’ä»¶**: https://github.com/obsidianmd/obsidian-sample-plugin

---

**æœ€åæ›´æ–°**: 2025-11-09  
**ç‰ˆæœ¬**: 1.0  
**Token ä¼°ç®—**: ~1,000 tokens  
**åŠ è½½æ–¹å¼**: Auto-Attach  
**ä¼˜å…ˆçº§**: 100
