---
description: "核心铁律（每次会话必读）"
scopes: [chat, edit]
tags: [critical-rules, iron-rules, dialectical-thinking]
priority: 1
globs: ["**/*.ts", "**/*.js"]
alwaysApply: true
---

# 核心铁律

> **重要性**: ⭐⭐⭐⭐⭐ 最高优先级  
> **加载方式**: Always Applied  
> **适用范围**: 所有会话  

---

## 绝对禁止（5条）

### 1. 永不使用不安全的 DOM 操作

```typescript
❌ 永不使用 innerHTML 或 outerHTML
❌ 永不直接插入 HTML 字符串
✅ 使用 Obsidian 的 createEl、createDiv、appendText
✅ 使用 DOM API 创建和操作元素
```

**触发条件**：任何涉及 DOM 操作的代码

**检查清单**：
- [ ] 是否使用了 `innerHTML`？❌ **绝对禁止**
- [ ] 是否使用了 `outerHTML`？❌ **绝对禁止**
- [ ] 是否使用了 Obsidian 的辅助函数？✅ **推荐**
- [ ] 是否对用户输入进行了清理？✅ **必须**

### 2. 永不跳过计划中的步骤

```markdown
❌ 步骤失败后继续下一步（未经允许）
❌ 部分完成就标记"完成"
❌ 自己决定"先做其他的"
✅ 逐项完成并验收
✅ 失败时立即停止并报告
✅ 等待用户明确允许后才继续
```

### 3. 永不在没有 BUILD 成功的情况下声称"编译通过"

```bash
❌ 看 linter 没报错就说"编译通过"
❌ "应该没问题"就是"编译通过"
✅ 必须运行 npm run build
✅ 必须看到 Build succeeded
✅ 复制输出作为证据
```

### 4. 永不擅自决定"先做其他的"（失败时必须停止）

```markdown
场景：Step 3 部署失败

❌ 错误：标记 "pending"，继续 Step 4
✅ 正确：
   1. 🛑 立即停止
   2. 报告："Step 3 失败（具体原因）"
   3. 询问："是否需要：A. 重试 / B. 检查问题 / C. 继续（说明风险）"
   4. ⏸️  等待明确指示
```

### 5. 永不在 /docs 外创建正式架构文档

```markdown
✅ 正式文档放 docs/ 目录
✅ 临时文档放 .cursor/docs/ (带时间戳)
❌ 不要在项目根目录创建 .md 文档
❌ 不要在 .cursor/ 下创建永久性文档
```

---

## 必须遵守（5条）

### 1. 编码前必须制定计划并等待批准

```markdown
流程：
1. 用户提需求
2. 分析问题（涉及哪些模块）
3. 提出方案（2-3 选 1）
4. 用户决策
5. 制定详细计划文档
6. 用户批准
7. 开始实施 ✅

❌ 禁止：听到需求就直接写代码
```

### 2. 代码变更后必须更新文档

```markdown
必须更新：
1. docs/STRUCTURE.md（如果新增文件）
   - 标记新增/修改的文件
   - 说明文件职责

2. 如果是重大变更 → 更新相关文档
   - docs/architecture/ (架构变更)
   - docs/api/ (API 变更)
   - docs/guides/ (使用方式变更)
```

### 3. 避免使用 `as any` 类型断言

```typescript
✅ 正确：
interface Config {
    apiKey: string;
    timeout?: number;
}

const config: Config = {
    apiKey: settings.apiKey,
    timeout: settings.timeout ?? 5000
};

❌ 错误：
const config = settings as any; // 缺少类型安全
```

### 4. 所有数据结构必须定义接口

```typescript
✅ 正确：
interface Message {
    role: 'user' | 'assistant';
    content: string;
    timestamp: number;
}

const message: Message = {
    role: 'user',
    content: 'Hello',
    timestamp: Date.now()
};

❌ 错误：
const message = { role: 'user', content: 'Hello' }; // 无类型定义
```

### 5. 重大变更必须创建文档说明

```markdown
以下变更属于重大变更，必须更新文档：
- 新增/修改主要功能
- 修改配置结构
- 修改 API 接口
- 引入新的第三方库
- 修改项目结构

流程：
1. 先在 .cursor/docs/ 创建临时文档
2. 讨论并确认方案
3. 整理为正式文档移到 docs/
4. 更新 README 或相关文档
```

---

## AI 工作原则：辨证思考铁律 ⭐⭐⭐⭐⭐

> **来源**: Epoch 项目经验教训  
> **目的**: 避免基于"找不到"就否定方案

### 知识边界原则

#### 1. 区分"不知道"和"知道不存在"

**问题本质**：
- "我找不到" ≠ "它不存在"
- 缺少证据 ≠ 反面证据

**正确做法**：
```markdown
❌ 错误："我找不到文档，所以这个功能不存在"
✅ 正确："我找不到文档，建议测试验证"
```

#### 2. 优先实验验证

**证据层级**（从高到低）：
1. ⭐⭐⭐ 实际测试结果
2. ⭐⭐ 官方文档明确说明
3. ⭐ 社区最佳实践（需验证）
4. ❌ 推测、假设

**决策流程**：
```
遇到不确定的问题
  ↓
找官方文档 → 找到 → 采纳
  ↓
找不到
  ↓
设计实验验证 → 得出结论（不要纯推测）
```

#### 3. 承认错误

**发现错误时**：
1. ✅ 立即承认："我错了，[具体错在哪]"
2. ✅ 说明原因："因为我[错误的假设/推理]"
3. ✅ 更新规则："我会记住[教训]，避免重复"

#### 4. 用户也可能错

**辨证思维**：
- 不要盲目服从用户
- 也不要盲目反对用户
- 辨证地分析，实事求是

**正确做法**：
```markdown
当用户可能错误时：
✅ 礼貌但明确地指出："我发现了一个潜在问题..."
✅ 提供证据："因为[具体原因/数据]"
✅ 建议验证："建议我们先测试一下[具体步骤]"

❌ 不要：因为"怕得罪用户"就不指出错误
```

#### 5. 禁止模棱两可

**禁用词汇**：
- ❌ "可能"、"大概"、"应该"、"也许"
- ❌ "需要进一步查证"（然后就不管了）
- ❌ "理论上"、"一般来说"

**替代表述**：
```markdown
情况 1：确实不知道
✅ "我不知道这个机制是否支持。建议通过 [具体测试步骤] 验证。"

情况 2：有证据但不完全确定
✅ "根据 [证据来源]，这个方案可行。但为了确保，建议先做 [小范围测试]。"

情况 3：需要用户提供信息
✅ "这取决于 [具体因素]。请告诉我 [需要的信息]，我才能给出准确建议。"
```

---

## 任务执行红线（核心原则）

> **完整版**: 见 `207-task-execution-detailed.mdc`

### 核心铁律（100字）

**铁律**：计划中的每个步骤必须逐项完成并验收，不得跳过。任何步骤失败或未完成时，立即停止所有工作，明确报告问题，等待用户明确允许后才能继续下一步。禁止擅自决定"先做其他的"或"这步可以跳过"。

### 四大原则（简化版）

#### 1️⃣ 必须逐项执行

```markdown
✅ 正确：Step 1 → 完成 → Step 2 → 完成 → Step 3
❌ 错误：Step 1 → 失败 → 跳过 → Step 2 继续
```

#### 2️⃣ 失败时必须停止

```markdown
任务失败 → 🛑 立即停止 → 报告 → 询问："A/B/C？" → ⏸️  等待指示

❌ 禁止：标记 "pending" 就继续下一步
```

#### 3️⃣ 验收标准明确

```bash
✅ 编译：必须看到 Build succeeded
✅ 部署：必须看到服务状态 Running
✅ 测试：必须有具体场景结果
```

#### 4️⃣ 等待明确允许

```markdown
✅ 明确的允许："继续"、"执行"、"Option A"
❌ 不能推测："用户可能想..."
```

---

## 场景触发规则

> 当你编辑以下文件时，Cursor 会自动加载对应的场景规则

| 文件模式 | 自动加载的规则 | 内容 |
|---------|--------------|------|
| `**/*.ts`, `**/*.js` | 100-obsidian-plugin-checklist.mdc | Obsidian 插件开发规范 |
| `**/*.ts` | 101-typescript-checklist.mdc | TypeScript 最佳实践 |
| `**/MarkdownRenderer.ts`, `**/ChatView.ts` | 102-markdown-rendering-checklist.mdc | Markdown/CodeMirror 相关 |

**使用方式**：
- 场景规则会在你打开对应文件时**自动加载**
- 不需要手动引用
- 只在需要时加载，节省 token

---

## 详细参考索引

> 需要详细说明时，手动查阅以下文件（不会自动加载）

| 文件 | 内容 | 何时查阅 |
|------|------|---------|
| 200-project-overview-detailed.mdc | 项目概述、完整背景、架构设计 | 新会话开始时 |
| 204-anti-overengineering-detailed.mdc | 防止过度设计详解、证据优先 | 设计新功能、评估复杂度时 |
| 207-task-execution-detailed.mdc | 任务执行红线详解、验收标准 | 执行复杂任务时 |

**访问方式**：
- 在 Chat 中提及文件名即可加载
- 例如："请参考 204-anti-overengineering-detailed.mdc"

---

## 快速检查清单

### 每次会话开始时
- [ ] ✅ 读取 000-critical-rules.mdc（本文件）
- [ ] ✅ 读取 001-project-context.mdc（项目状态）
- [ ] ✅ 在回复开头确认："✅ 已读取核心铁律 + AIPilot 项目状态"

### 接到任务时
- [ ] 任务涉及特定领域？→ 场景规则会自动加载
- [ ] 不确定如何开始？→ 先看 002-ai-checklist.mdc
- [ ] 需要详细参考？→ 查阅 200-207 系列文件

### 执行计划时
- [ ] 每个步骤必须逐项完成（任务执行红线）
- [ ] 失败时立即停止并询问
- [ ] 编译验证必须看到 Build succeeded
- [ ] 测试必须有明确结果

### 遇到不确定问题时
- [ ] 优先查找官方文档
- [ ] 找不到文档 → 设计实验验证
- [ ] 禁止纯推测（辨证思考铁律）
- [ ] 不确定时明确说"我不知道，建议验证"

---

**最后更新**: 2025-11-09  
**版本**: 1.0  
**Token 估算**: ~5,000 tokens  
**加载方式**: Always Applied  
**优先级**: 1（最高）
