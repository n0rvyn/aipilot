---
description: "Markdown æ¸²æŸ“å’Œ CodeMirror æ£€æŸ¥æ¸…å•"
scopes: [chat, edit]
tags: [markdown, codemirror, rendering, security]
priority: 102
globs: ["**/MarkdownRenderer.ts", "**/ChatView.ts", "**/markdown*.ts"]
alwaysApply: false
---

# Markdown æ¸²æŸ“æ£€æŸ¥æ¸…å•

> **é‡è¦æ€§**: â­â­â­â­ é«˜ä¼˜å…ˆçº§  
> **åŠ è½½æ–¹å¼**: Auto-Attachï¼ˆç¼–è¾‘ Markdown ç›¸å…³æ–‡ä»¶æ—¶è‡ªåŠ¨åŠ è½½ï¼‰  
> **ç”¨é€”**: Markdown æ¸²æŸ“å’Œ CodeMirror é›†æˆçš„æœ€ä½³å®è·µ  

---

## ğŸ”’ å®‰å…¨æ¸²æŸ“

### 1. ä½¿ç”¨ Obsidian çš„ MarkdownRenderer

```typescript
import { MarkdownRenderer } from 'obsidian';

// âœ… æ¨èï¼šä½¿ç”¨ Obsidian çš„å®‰å…¨æ¸²æŸ“å™¨
async function renderMarkdown(markdown: string, container: HTMLElement) {
    container.empty();
    
    await MarkdownRenderer.render(
        this.app,
        markdown,
        container,
        '', // sourcePathï¼ˆå¯é€‰ï¼‰
        this // component
    );
}

// âŒ å±é™©ï¼šç›´æ¥æ’å…¥ HTML
container.innerHTML = marked(markdown); // XSS é£é™©ï¼
```

### 2. æ¸…ç†ç”¨æˆ·è¾“å…¥

```typescript
// âœ… Obsidian çš„æ¸²æŸ“å™¨ä¼šè‡ªåŠ¨å¤„ç†
await MarkdownRenderer.render(
    this.app,
    userInput, // å®‰å…¨ï¼Œä¼šè‡ªåŠ¨æ¸…ç†
    container,
    '',
    this
);

// âœ… å¦‚æœå¿…é¡»ä½¿ç”¨ markedï¼Œé…ç½®å®‰å…¨é€‰é¡¹
import { marked } from 'marked';

marked.setOptions({
    sanitize: false, // marked ä¸å†æ”¯æŒ sanitize
    breaks: true,
    gfm: true
});

// ä½¿ç”¨ DOMPurify æ¸…ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
import DOMPurify from 'dompurify';
const clean = DOMPurify.sanitize(html);
```

---

## ğŸ“ Markdown æ¸²æŸ“æ¨¡å¼

### Obsidian MarkdownRenderer API

```typescript
// åŸºæœ¬ç”¨æ³•
await MarkdownRenderer.render(
    this.app,              // App å®ä¾‹
    markdown,              // Markdown å­—ç¬¦ä¸²
    container,             // æ¸²æŸ“ç›®æ ‡å®¹å™¨
    sourcePath,            // æºæ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºé“¾æ¥è§£æï¼‰
    component              // ç»„ä»¶å®ä¾‹ï¼ˆç”¨äºç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼‰
);

// æ¸²æŸ“åå¤„ç†
await MarkdownRenderer.render(this.app, markdown, container, '', this);

// æ·»åŠ è‡ªå®šä¹‰ç±»
container.addClass('my-markdown-content');

// å¤„ç†å†…éƒ¨é“¾æ¥
container.querySelectorAll('a.internal-link').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const target = link.getAttribute('data-href');
        this.app.workspace.openLinkText(target, '');
    });
});
```

---

## ğŸ¨ ä»£ç é«˜äº®

### ä½¿ç”¨ CodeMirror æ¸²æŸ“ä»£ç å—

```typescript
import { EditorView } from '@codemirror/view';
import { EditorState } from '@codemirror/state';
import { javascript } from '@codemirror/lang-javascript';
import { python } from '@codemirror/lang-python';
import { oneDark } from '@codemirror/theme-one-dark';

// âœ… åˆ›å»º CodeMirror ç¼–è¾‘å™¨
function renderCodeBlock(code: string, language: string, container: HTMLElement) {
    const extensions = [
        EditorView.editable.of(false), // åªè¯»
        EditorState.readOnly.of(true),
        getLanguageExtension(language),
        oneDark // ä¸»é¢˜ï¼ˆå¯é€‰ï¼‰
    ];
    
    const state = EditorState.create({
        doc: code,
        extensions
    });
    
    const view = new EditorView({
        state,
        parent: container
    });
    
    return view;
}

function getLanguageExtension(language: string) {
    switch (language.toLowerCase()) {
        case 'javascript':
        case 'js':
            return javascript();
        case 'python':
        case 'py':
            return python();
        // æ·»åŠ æ›´å¤šè¯­è¨€æ”¯æŒ
        default:
            return [];
    }
}
```

### ä»£ç å—å¤åˆ¶åŠŸèƒ½

```typescript
// âœ… æ·»åŠ å¤åˆ¶æŒ‰é’®
function addCopyButton(codeBlock: HTMLElement, code: string) {
    const copyBtn = codeBlock.createEl('button', {
        text: 'Copy',
        cls: 'copy-code-button'
    });
    
    copyBtn.addEventListener('click', async () => {
        try {
            await navigator.clipboard.writeText(code);
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy';
            }, 2000);
        } catch (error) {
            console.error('Failed to copy:', error);
        }
    });
}
```

---

## ğŸ¯ è‡ªå®šä¹‰ Markdown å¤„ç†

### æ‰©å±• Markdown è¯­æ³•

```typescript
import { marked } from 'marked';

// âœ… è‡ªå®šä¹‰æ¸²æŸ“å™¨
const renderer = new marked.Renderer();

// è‡ªå®šä¹‰é“¾æ¥æ¸²æŸ“
renderer.link = (href, title, text) => {
    const isInternal = href?.startsWith('[[') && href?.endsWith(']]');
    
    if (isInternal) {
        const target = href.slice(2, -2);
        return `<a class="internal-link" data-href="${target}">${text}</a>`;
    }
    
    return `<a href="${href}" title="${title || ''}" target="_blank">${text}</a>`;
};

// è‡ªå®šä¹‰ä»£ç å—æ¸²æŸ“
renderer.code = (code, language) => {
    const lang = language || 'text';
    return `<div class="code-block" data-language="${lang}">
        <pre><code class="language-${lang}">${escapeHtml(code)}</code></pre>
    </div>`;
};

// ä½¿ç”¨è‡ªå®šä¹‰æ¸²æŸ“å™¨
marked.use({ renderer });
```

### å¤„ç†æ•°å­¦å…¬å¼ï¼ˆLaTeXï¼‰

```typescript
// âœ… ä½¿ç”¨ Obsidian çš„æ•°å­¦æ¸²æŸ“
async function renderMath(latex: string, container: HTMLElement, displayMode: boolean) {
    // Obsidian ä¼šè‡ªåŠ¨å¤„ç† $...$ å’Œ $$...$$ è¯­æ³•
    // é€šè¿‡ MarkdownRenderer.render() å³å¯
    await MarkdownRenderer.render(
        this.app,
        displayMode ? `$$${latex}$$` : `$${latex}$`,
        container,
        '',
        this
    );
}
```

---

## ğŸ­ æµå¼æ¸²æŸ“ï¼ˆStreamingï¼‰

### å®æ—¶æ›´æ–° Markdown å†…å®¹

```typescript
class StreamingRenderer {
    private container: HTMLElement;
    private currentContent: string = '';
    
    constructor(container: HTMLElement) {
        this.container = container;
    }
    
    // âœ… è¿½åŠ å†…å®¹å¹¶é‡æ–°æ¸²æŸ“
    async append(chunk: string) {
        this.currentContent += chunk;
        await this.render();
    }
    
    // âœ… æ¸²æŸ“å½“å‰å†…å®¹
    async render() {
        this.container.empty();
        await MarkdownRenderer.render(
            this.app,
            this.currentContent,
            this.container,
            '',
            this
        );
    }
    
    // âœ… æ¸…ç©ºå†…å®¹
    clear() {
        this.currentContent = '';
        this.container.empty();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const renderer = new StreamingRenderer(container);

// æ¥æ”¶æµå¼æ•°æ®
for await (const chunk of streamResponse) {
    await renderer.append(chunk);
}
```

### æ€§èƒ½ä¼˜åŒ–ï¼šèŠ‚æµæ¸²æŸ“

```typescript
// âœ… é¿å…é¢‘ç¹é‡æ–°æ¸²æŸ“
class ThrottledRenderer {
    private container: HTMLElement;
    private buffer: string = '';
    private timeout: NodeJS.Timeout | null = null;
    private readonly RENDER_DELAY = 100; // ms
    
    async append(chunk: string) {
        this.buffer += chunk;
        
        // å–æ¶ˆä¹‹å‰çš„æ¸²æŸ“è®¡åˆ’
        if (this.timeout) {
            clearTimeout(this.timeout);
        }
        
        // å»¶è¿Ÿæ¸²æŸ“
        this.timeout = setTimeout(async () => {
            await this.render();
            this.timeout = null;
        }, this.RENDER_DELAY);
    }
    
    async flush() {
        // ç«‹å³æ¸²æŸ“å‰©ä½™å†…å®¹
        if (this.timeout) {
            clearTimeout(this.timeout);
            this.timeout = null;
        }
        await this.render();
    }
    
    private async render() {
        this.container.empty();
        await MarkdownRenderer.render(
            this.app,
            this.buffer,
            this.container,
            '',
            this
        );
    }
}
```

---

## ğŸ“‹ å¸¸è§é—®é¢˜

### 1. å†…éƒ¨é“¾æ¥ä¸å·¥ä½œ

```typescript
// âœ… å¤„ç† Obsidian å†…éƒ¨é“¾æ¥
container.querySelectorAll('a.internal-link').forEach(link => {
    link.addEventListener('click', async (e) => {
        e.preventDefault();
        const target = link.getAttribute('data-href');
        if (target) {
            // æ‰“å¼€ç¬”è®°
            this.app.workspace.openLinkText(target, '', false);
        }
    });
});
```

### 2. ä»£ç å—æ»šåŠ¨é—®é¢˜

```css
/* æ·»åŠ åˆ° styles.css */
.code-block {
    overflow-x: auto;
    max-width: 100%;
}

.code-block pre {
    margin: 0;
    padding: 1em;
}
```

### 3. æ•°å­¦å…¬å¼æ¸²æŸ“å¤±è´¥

```typescript
// âœ… ç¡®ä¿ Obsidian çš„æ•°å­¦æ¸²æŸ“å·²åŠ è½½
// é€šå¸¸é€šè¿‡ MarkdownRenderer.render() è‡ªåŠ¨å¤„ç†
// å¦‚æœæœ‰é—®é¢˜ï¼Œæ£€æŸ¥ Obsidian è®¾ç½®ä¸­çš„ MathJax é…ç½®
```

---

## ğŸ¨ æ ·å¼å®šåˆ¶

### Markdown å†…å®¹æ ·å¼

```css
/* styles.css */

/* åŸºç¡€æ ·å¼ */
.markdown-content {
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-normal);
}

/* æ ‡é¢˜ */
.markdown-content h1 { font-size: 2em; }
.markdown-content h2 { font-size: 1.5em; }
.markdown-content h3 { font-size: 1.25em; }

/* ä»£ç å— */
.markdown-content pre {
    background: var(--code-background);
    padding: 1em;
    border-radius: 4px;
    overflow-x: auto;
}

.markdown-content code {
    background: var(--code-background);
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: var(--font-monospace);
}

/* é“¾æ¥ */
.markdown-content a {
    color: var(--link-color);
    text-decoration: none;
}

.markdown-content a:hover {
    text-decoration: underline;
}

/* åˆ—è¡¨ */
.markdown-content ul, .markdown-content ol {
    padding-left: 2em;
}

/* å¼•ç”¨ */
.markdown-content blockquote {
    border-left: 3px solid var(--quote-opening-modifier);
    padding-left: 1em;
    margin-left: 0;
    color: var(--text-muted);
}
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### Markdown æ¸²æŸ“æ£€æŸ¥

- [ ] **å®‰å…¨æ€§**
  - [ ] ä½¿ç”¨ Obsidian MarkdownRenderer
  - [ ] ç”¨æˆ·è¾“å…¥å·²æ¸…ç†
  - [ ] é¿å…ç›´æ¥ innerHTML

- [ ] **åŠŸèƒ½å®Œæ•´æ€§**
  - [ ] å†…éƒ¨é“¾æ¥æ­£å¸¸å·¥ä½œ
  - [ ] ä»£ç é«˜äº®æ­£ç¡®æ˜¾ç¤º
  - [ ] æ•°å­¦å…¬å¼æ­£ç¡®æ¸²æŸ“
  - [ ] å›¾ç‰‡æ­£ç¡®åŠ è½½

- [ ] **æ€§èƒ½**
  - [ ] æµå¼æ¸²æŸ“ä½¿ç”¨èŠ‚æµ
  - [ ] å¤§æ–‡æœ¬ä¸é˜»å¡ UI
  - [ ] åŠæ—¶æ¸…ç† DOM

- [ ] **ç”¨æˆ·ä½“éªŒ**
  - [ ] ä»£ç å—å¯å¤åˆ¶
  - [ ] æ ·å¼ç¬¦åˆä¸»é¢˜
  - [ ] ç§»åŠ¨ç«¯é€‚é…

---

## ğŸ”— ç›¸å…³èµ„æº

- **Obsidian MarkdownRenderer**: https://docs.obsidian.md/Reference/TypeScript+API/MarkdownRenderer
- **CodeMirror 6**: https://codemirror.net/docs/
- **marked**: https://marked.js.org/

---

**æœ€åæ›´æ–°**: 2025-11-09  
**ç‰ˆæœ¬**: 1.0  
**Token ä¼°ç®—**: ~600 tokens  
**åŠ è½½æ–¹å¼**: Auto-Attach  
**ä¼˜å…ˆçº§**: 102
