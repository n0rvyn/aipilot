---
description: "é¡¹ç›®æ¦‚è¿° - å®Œæ•´èƒŒæ™¯å’Œæ¶æ„è®¾è®¡ - è¯¦ç»†å‚è€ƒ"
scopes: [chat, edit]
tags: [project-overview, architecture, background, detailed-reference]
priority: 200
globs: []
alwaysApply: false
---

# AIPilot é¡¹ç›®æ¦‚è¿°ï¼ˆè¯¦ç»†å‚è€ƒï¼‰

> **æ³¨æ„**ï¼šæœ¬æ–‡ä»¶ä¸ºè¯¦ç»†å‚è€ƒï¼Œä¸ä¼šè‡ªåŠ¨åŠ è½½ã€‚  
> **ç®€ç‰ˆ**: è§ `001-project-context.mdc`

---

## ğŸ“– é¡¹ç›®èƒŒæ™¯

### é¡¹ç›®èµ·æº

AIPilot æ˜¯ä¸€ä¸ªä¸º Obsidian è®¾è®¡çš„ AI åŠ©æ‰‹æ’ä»¶ï¼Œæ—¨åœ¨å¢å¼ºçŸ¥è¯†ç®¡ç†å’Œå†™ä½œä½“éªŒã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
1. å°† AI èƒ½åŠ›æ·±åº¦é›†æˆåˆ° Obsidian å·¥ä½œæµ
2. åˆ©ç”¨æœ¬åœ°ç¬”è®°ä½œä¸ºä¸Šä¸‹æ–‡ï¼ˆRAGï¼‰
3. æä¾›å¤šæ ·åŒ–çš„ AI åŠŸèƒ½ï¼ˆèŠå¤©ã€æ¶¦è‰²ã€è¾©è®ºï¼‰
4. æ”¯æŒå¤šä¸ª AI æä¾›å•†ï¼Œå¢åŠ çµæ´»æ€§

### æŠ€æœ¯é€‰å‹

**ä¸ºä»€ä¹ˆé€‰æ‹© TypeScriptï¼Ÿ**
- Obsidian æ’ä»¶å®˜æ–¹å¼€å‘è¯­è¨€
- ç±»å‹å®‰å…¨ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
- è‰¯å¥½çš„ IDE æ”¯æŒå’Œä»£ç æç¤º

**ä¸ºä»€ä¹ˆé€‰æ‹© esbuildï¼Ÿ**
- æå¿«çš„æ„å»ºé€Ÿåº¦
- ç®€å•çš„é…ç½®
- è‰¯å¥½çš„ TypeScript æ”¯æŒ

**ä¸ºä»€ä¹ˆé€‰æ‹©è¿™äº›ä¾èµ–ï¼Ÿ**
- **CodeMirror 6**: Obsidian ä½¿ç”¨çš„ç¼–è¾‘å™¨ï¼Œæ·±åº¦é›†æˆ
- **marked**: è½»é‡çº§ Markdown è§£æå™¨
- **tiktoken**: å‡†ç¡®çš„ token è®¡æ•°ï¼ˆå…¼å®¹ OpenAIï¼‰
- **axios**: å¯é çš„ HTTP å®¢æˆ·ç«¯

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Obsidian Application          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   AIPilot Plugin  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ Views  â”‚      â”‚  Services   â”‚
â”‚        â”‚      â”‚             â”‚
â”‚ Chat   â”‚      â”‚ AI Service  â”‚
â”‚ KB     â”‚      â”‚ RAG Service â”‚
â”‚ Debate â”‚      â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. Plugin Entry (main.ts)

```typescript
// æ’ä»¶å…¥å£ï¼Œè´Ÿè´£ï¼š
// - ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆonload/onunloadï¼‰
// - è§†å›¾æ³¨å†Œ
// - å‘½ä»¤æ³¨å†Œ
// - è®¾ç½®ç®¡ç†

export default class AIPilot extends Plugin {
    settings: AIPilotSettings;
    
    async onload() {
        // åˆå§‹åŒ–
    }
}
```

#### 2. Viewsï¼ˆè§†å›¾å±‚ï¼‰

**ChatView** (`src/ChatView.ts`)
- èŠå¤©ç•Œé¢
- æ¶ˆæ¯æ¸²æŸ“
- æµå¼å“åº”å¤„ç†
- è‡ªå®šä¹‰åŠŸèƒ½æŒ‰é’®

**KnowledgeBaseView** (`src/KnowledgeBaseView.ts`)
- çŸ¥è¯†åº“ç®¡ç†
- æ–‡æ¡£æ£€ç´¢
- å‘é‡æœç´¢

**DebatePanel** (`src/debate/DebatePanel.ts`)
- å¤šä»£ç†è¾©è®ºç•Œé¢
- è§†è§’åˆ‡æ¢
- è®¨è®ºçº¿ç´¢

#### 3. Servicesï¼ˆæœåŠ¡å±‚ï¼‰

**AIService** (`src/services/AIService.ts`)
- ç»Ÿä¸€çš„ AI æ¥å£
- å¤šæä¾›å•†æ”¯æŒï¼ˆOpenAIã€æ™ºè°±ã€Groqï¼‰
- æµå¼å“åº”å¤„ç†

**RAGService** (`src/rag/RAGService.ts`)
- æ–‡æ¡£æ£€ç´¢
- å‘é‡åŒ–
- ä¸Šä¸‹æ–‡æ„å»º

#### 4. Modelsï¼ˆæ¨¡å‹å±‚ï¼‰

**ModelManager** (`src/models/ModelManager.ts`)
- æ¨¡å‹é…ç½®ç®¡ç†
- æ¨¡å‹åˆ‡æ¢
- å‚æ•°è°ƒæ•´

---

## ğŸ“ è®¾è®¡æ¨¡å¼

### 1. Plugin Pattern

```typescript
// Obsidian æ’ä»¶æ¨¡å¼
export default class AIPilot extends Plugin {
    // æ’ä»¶ç”Ÿå‘½å‘¨æœŸ
    async onload() { }
    onunload() { }
    
    // è®¾ç½®ç®¡ç†
    async loadSettings() { }
    async saveSettings() { }
}
```

**ä¸ºä»€ä¹ˆ**ï¼š
- éµå¾ª Obsidian å®˜æ–¹è§„èŒƒ
- è‡ªåŠ¨ç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸ
- ç»Ÿä¸€çš„æ’ä»¶æ¥å£

### 2. View Pattern

```typescript
// è‡ªå®šä¹‰è§†å›¾æ¨¡å¼
export class ChatView extends ItemView {
    getViewType() { return 'aipilot-chat'; }
    getDisplayText() { return 'AI Chat'; }
    
    async onOpen() { /* åˆå§‹åŒ– UI */ }
    async onClose() { /* æ¸…ç†èµ„æº */ }
}
```

**ä¸ºä»€ä¹ˆ**ï¼š
- Obsidian æ¨èçš„è§†å›¾åˆ›å»ºæ–¹å¼
- è‡ªåŠ¨é›†æˆåˆ°å·¥ä½œåŒº
- çŠ¶æ€ä¿å­˜å’Œæ¢å¤

### 3. Service Pattern

```typescript
// æœåŠ¡æ¥å£æ¨¡å¼
interface AIServiceInterface {
    generate(prompt: string): Promise<string>;
    stream(prompt: string): AsyncIterator<string>;
}

class OpenAIService implements AIServiceInterface {
    // å…·ä½“å®ç°
}
```

**ä¸ºä»€ä¹ˆ**ï¼š
- æ˜“äºæ‰©å±•æ–°çš„ AI æä¾›å•†
- ç»Ÿä¸€çš„æ¥å£ï¼Œé™ä½è€¦åˆ
- ä¾¿äºæµ‹è¯•å’Œ mock

---

## ğŸ”„ æ•°æ®æµ

### èŠå¤©æµç¨‹

```
User Input
   â†“
ChatView (UI)
   â†“
AIService (é€‰æ‹©æä¾›å•†)
   â†“
RAGService (æ£€ç´¢ç›¸å…³æ–‡æ¡£)
   â†“
API Request (OpenAI/Zhipu/Groq)
   â†“
Stream Response
   â†“
MarkdownRenderer (æ¸²æŸ“)
   â†“
Display to User
```

### RAG æµç¨‹

```
User Query
   â†“
RAGService.search()
   â†“
1. å‘é‡åŒ–æŸ¥è¯¢
2. æœç´¢ç›¸ä¼¼æ–‡æ¡£
3. æ’åºå’Œè¿‡æ»¤
   â†“
æ„å»ºä¸Šä¸‹æ–‡
   â†“
å‘é€åˆ° AI
   â†“
å¢å¼ºçš„å›ç­”
```

---

## ğŸ—‚ï¸ æ–‡ä»¶ç»„ç»‡

### æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | è¡Œæ•° | èŒè´£ | å¤æ‚åº¦ |
|------|------|------|--------|
| `main.ts` | 2000+ | æ’ä»¶å…¥å£ã€è®¾ç½®ã€å‘½ä»¤ | é«˜ |
| `ChatView.ts` | 2000+ | èŠå¤©ç•Œé¢ã€æ¶ˆæ¯ç®¡ç† | é«˜ |
| `MarkdownRenderer.ts` | 500+ | Markdown æ¸²æŸ“ã€ä»£ç é«˜äº® | ä¸­ |
| `AIService.ts` | 400+ | AI è¯·æ±‚å¤„ç† | ä¸­ |
| `RAGService.ts` | 600+ | æ–‡æ¡£æ£€ç´¢ã€å‘é‡åŒ– | ä¸­ |
| `ModelManager.ts` | 300+ | æ¨¡å‹é…ç½®ç®¡ç† | ä½ |

### ç›®å½•èŒè´£

```
src/
â”œâ”€â”€ main.ts              # æ’ä»¶å…¥å£
â”œâ”€â”€ ChatView.ts          # èŠå¤©è§†å›¾
â”œâ”€â”€ KnowledgeBaseView.ts # çŸ¥è¯†åº“è§†å›¾
â”œâ”€â”€ MarkdownRenderer.ts  # æ¸²æŸ“å™¨
â”œâ”€â”€ icons.ts             # å›¾æ ‡å®šä¹‰
â”œâ”€â”€ modals.ts            # å¯¹è¯æ¡†
â”œâ”€â”€ styles.css           # æ ·å¼
â”‚
â”œâ”€â”€ debate/              # å¤šä»£ç†è¾©è®º
â”‚   â”œâ”€â”€ AgentDebateEngine.ts
â”‚   â””â”€â”€ DebatePanel.ts
â”‚
â”œâ”€â”€ models/              # æ¨¡å‹ç®¡ç†
â”‚   â”œâ”€â”€ ModelManager.ts
â”‚   â”œâ”€â”€ ModelConfigModal.ts
â”‚   â””â”€â”€ EmbeddingModelConfigModal.ts
â”‚
â”œâ”€â”€ rag/                 # RAG ç³»ç»Ÿ
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ AIService.ts
â”‚   â”œâ”€â”€ RAGService.ts
â”‚   â”œâ”€â”€ enhancement/     # æŸ¥è¯¢å¢å¼º
â”‚   â”œâ”€â”€ ranking/         # ç»“æœæ’åº
â”‚   â”œâ”€â”€ reflection/      # åæ€æœºåˆ¶
â”‚   â””â”€â”€ retrieval/       # æ£€ç´¢æ¨¡å—
â”‚
â””â”€â”€ services/            # æœåŠ¡å±‚
    â”œâ”€â”€ AIService.ts
    â””â”€â”€ RAGService.ts
```

---

## ğŸ”§ å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. æµå¼å“åº”å¤„ç†

```typescript
async function* streamResponse(prompt: string): AsyncIterator<string> {
    const response = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ prompt, stream: true }),
        headers: { /* ... */ }
    });
    
    const reader = response.body?.getReader();
    const decoder = new TextDecoder();
    
    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value);
        yield chunk;
    }
}
```

**ä¸ºä»€ä¹ˆä½¿ç”¨æµå¼**ï¼š
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼ˆå®æ—¶åé¦ˆï¼‰
- é™ä½é¦–æ¬¡å“åº”å»¶è¿Ÿ
- æ”¯æŒå¤§æ–‡æœ¬ç”Ÿæˆ

### 2. å®‰å…¨çš„ DOM æ“ä½œ

```typescript
// âœ… å®‰å…¨ï¼šä½¿ç”¨ Obsidian API
const container = this.containerEl.createDiv({ cls: 'chat-message' });
container.appendText(userInput); // è‡ªåŠ¨è½¬ä¹‰

// âŒ å±é™©ï¼šç›´æ¥ innerHTML
container.innerHTML = userInput; // XSS é£é™©
```

**ä¸ºä»€ä¹ˆ**ï¼š
- é˜²æ­¢ XSS æ”»å‡»
- éµå¾ª Obsidian å®‰å…¨è§„èŒƒ
- è‡ªåŠ¨å¤„ç†ç‰¹æ®Šå­—ç¬¦

### 3. é”™è¯¯å¤„ç†ç­–ç•¥

```typescript
try {
    const result = await apiCall();
    return result;
} catch (error) {
    // 1. è®°å½•è¯¦ç»†é”™è¯¯
    console.error('API call failed:', error);
    
    // 2. ç”¨æˆ·å‹å¥½æç¤º
    new Notice('Failed to connect to AI service');
    
    // 3. ä¼˜é›…é™çº§
    return fallbackResult;
}
```

**ä¸ºä»€ä¹ˆ**ï¼š
- é¿å…æ’ä»¶å´©æºƒ
- æä¾›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
- ä¿æŒç”¨æˆ·ä½“éªŒ

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### 1. æ‡’åŠ è½½

```typescript
// è§†å›¾åªåœ¨éœ€è¦æ—¶åˆ›å»º
this.registerView(VIEW_TYPE, (leaf) => {
    return new ChatView(leaf);
});
```

### 2. äº‹ä»¶é˜²æŠ–

```typescript
// é¿å…é¢‘ç¹çš„ API è°ƒç”¨
const debouncedSearch = debounce(async (query: string) => {
    const results = await ragService.search(query);
    this.updateResults(results);
}, 300);
```

### 3. ç¼“å­˜ç­–ç•¥

```typescript
// ç¼“å­˜ AI å“åº”
const cache = new Map<string, string>();

async function getCachedResponse(prompt: string): Promise<string> {
    if (cache.has(prompt)) {
        return cache.get(prompt)!;
    }
    
    const response = await aiService.generate(prompt);
    cache.set(prompt, response);
    return response;
}
```

---

## ğŸ” å®‰å…¨æªæ–½

### 1. API Key ä¿æŠ¤

```typescript
// è®¾ç½®ä¸­å­˜å‚¨ï¼Œä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç 
interface Settings {
    apiKey: string; // ç”±ç”¨æˆ·é…ç½®
}

// ä¸åœ¨æ—¥å¿—ä¸­è¾“å‡º
console.log('API Key:', '***'); // è„±æ•
```

### 2. è¾“å…¥éªŒè¯

```typescript
function validateInput(input: string): boolean {
    if (!input || input.trim().length === 0) {
        return false;
    }
    
    if (input.length > MAX_LENGTH) {
        new Notice('Input too long');
        return false;
    }
    
    return true;
}
```

### 3. æƒé™æœ€å°åŒ–

```typescript
// åªè¯·æ±‚å¿…è¦çš„æƒé™
// ä¸è®¿é—®ä¸éœ€è¦çš„æ–‡ä»¶
// ä¸æ‰§è¡Œä¸å®‰å…¨çš„æ“ä½œ
```

---

## ğŸ“š å…³é”®æ–‡æ¡£ç´¢å¼•

### æ¶æ„æ–‡æ¡£
- `docs/architecture/overview.md` - æ¶æ„æ€»è§ˆ
- `docs/architecture/plugin-lifecycle.md` - æ’ä»¶ç”Ÿå‘½å‘¨æœŸ
- `docs/architecture/rag-system.md` - RAG ç³»ç»Ÿè®¾è®¡
- `docs/architecture/debate-system.md` - è¾©è®ºç³»ç»Ÿ

### API æ–‡æ¡£
- `docs/api/main-plugin.md` - ä¸»æ’ä»¶ API
- `docs/api/chat-view.md` - èŠå¤©è§†å›¾ API
- `docs/api/rag-service.md` - RAG æœåŠ¡ API

### å¼€å‘æ–‡æ¡£
- `docs/development/setup.md` - å¼€å‘ç¯å¢ƒæ­å»º
- `docs/development/build-process.md` - æ„å»ºæµç¨‹
- `docs/development/contributing.md` - è´¡çŒ®æŒ‡å—

---

## ğŸ¯ è®¾è®¡å†³ç­–è®°å½•

### ä¸ºä»€ä¹ˆä½¿ç”¨ marked è€Œä¸æ˜¯å…¶ä»– Markdown è§£æå™¨ï¼Ÿ

**å†³ç­–**: ä½¿ç”¨ marked

**ç†ç”±**:
1. è½»é‡çº§ï¼ˆ~20KBï¼‰
2. é«˜åº¦å¯é…ç½®
3. ç¤¾åŒºæ´»è·ƒ
4. ä¸ CodeMirror é›†æˆè‰¯å¥½

### ä¸ºä»€ä¹ˆæ”¯æŒå¤šä¸ª AI æä¾›å•†ï¼Ÿ

**å†³ç­–**: æ”¯æŒ OpenAIã€æ™ºè°±AIã€Groq

**ç†ç”±**:
1. å¢åŠ çµæ´»æ€§ï¼ˆç”¨æˆ·å¯é€‰æ‹©ï¼‰
2. é™ä½ä¾èµ–é£é™©ï¼ˆAPI é™åˆ¶ã€æœåŠ¡ä¸­æ–­ï¼‰
3. æˆæœ¬ä¼˜åŒ–ï¼ˆä¸åŒæä¾›å•†ä»·æ ¼ä¸åŒï¼‰
4. åŠŸèƒ½äº’è¡¥ï¼ˆä¸åŒæ¨¡å‹æ“…é•¿é¢†åŸŸä¸åŒï¼‰

### ä¸ºä»€ä¹ˆä½¿ç”¨ RAG è€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ AIï¼Ÿ

**å†³ç­–**: å®ç° RAG ç³»ç»Ÿ

**ç†ç”±**:
1. åˆ©ç”¨æœ¬åœ°çŸ¥è¯†åº“
2. æä¾›æ›´å‡†ç¡®çš„ä¸Šä¸‹æ–‡
3. å‡å°‘å¹»è§‰é—®é¢˜
4. ç¬¦åˆ Obsidian ç”¨æˆ·å·¥ä½œæµ

---

**æœ€åæ›´æ–°**: 2025-11-09  
**ç‰ˆæœ¬**: 1.0  
**ç»´æŠ¤è€…**: AIPilot Development Team
